# мой проект статистика
# Расчет биоэквивалентности (Streamlit-приложение)
## Описание проекта
Данное репозиторий содержит Streamlit-приложение для автоматизированного расчета критериев биоэквивалентности и статистического анализа фармакокинетических данных. Приложение предназначено для работы с данными аналитиков (концентрации в крови) и дополнительными данными добровольцев (анкеты, результаты клинико-лабораторных анализов). Результатом работы является:
- вычисление фармакокинетических параметров (C<sub>max</sub>, T<sub>max</sub>, AUC<sub>0–t</sub>, AUC<sub>0–∞</sub>, k<sub>el</sub>, T<sub>1/2</sub>, CL, Vd, MRT, T<sub>lag</sub>) по каждому субъекту и периоду
- оценка геометрического среднего соотношения (GMR) и 90%-го доверительного интервала для C<sub>max</sub>, AUC<sub>0–t</sub> и AUC<sub>0–∞</sub>
- проведение ANOVA (лог-преобразованных значений) для каждого параметра
- расчет внутригрупповой вариабельности (CV<sub>intra</sub>) и sWR
- проверка критериев биоэквивалентности (80–125%) и выявление «виновников» при выходе за пределы
- построение графиков индивидуальных профилей, усредненных кривых, доверительных интервалов соотношения T/R и других визуализаций
- экспорт таблиц с результатами PK, остаточной площадью AUC, лог-преобразованными значениями, ANOVA-отчетом и другими статистическими таблицами в формате .docx
- анализ клинических данных добровольцев (общий анализ крови, биохимия, общий анализ мочи) с визуализацией до/после терапии
Для работы приложения необходимы файлы рандомизации, временных точек и аналитические Excel‑файлы концентраций. При запуске откроется веб‑интерфейс, через который можно загрузить данные и получить отчёты.
## Структура репозитория
├── app.py # Основной файл Streamlit-приложения
├── loader.py # Модуль загрузки и парсинга входных файлов
├── pk.py # Расчет фармакокинетических параметров (PK)
├── stat_tools.py # Статистические функции (лог-разности, CI, ANOVA, CV, GMR, выявление выбросов)
├── viz.py # Функции для построения графиков (концентрация vs время, CI, профильные кривые)
├── blood_analysis.py # Загрузка и визуализация данных ОАК, БХАК, ОАМ
├── docx_tools.py # Экспорт различных таблиц и отчетов в формате .docx
├── requirements.txt # Список зависимостей для установки среды
├── src/                  # вспомогательные модули (pk_workflow, data_loader, plot_utils, export_utils)
└── tests/                # набор тестов на pytest
└── README.md # Текущий файл


### Описание основных модулей
1. **`app.py`**  
   - Настройка интерфейса Streamlit (облачная боковая панель, основная область)  
   - Ввод доз тестового и референтного препаратов  
   - Загрузка четырех типов файлов:
     - файл рандомизации (CSV – колонки `Subject`, `Sequence`)
     - файл временных точек (CSV – колонки `Code`, `Time`)
     - набор файлов аналитика (XLSX) с данными концентраций
     - файл с клинико-лабораторными данными добровольцев (XLSX/XLSM)
   - Вызов парсера `loader.parse_excel_files` для формирования единого DataFrame с колонками:
     - `Subject`, `Sequence`, `Period`, `Treatment`, `SampleLabel`, `TimeCode`, `Time`, `Concentration`
   - Проверки: баланс последовательностей, соответствие точек и аналитических данных, наличие всех субъектов
   - Расчет PK-параметров с помощью `compute_pk` (модуль `pk.py`)
   - Формирование сводной таблицы PK и подготовка pivot-таблицы для статистики
   - Расчет GMR и 90% CI через `stat_tools.get_gmr_lsmeans`
   - Построение таблицы результатов расчетов и отметка соответствия критериям 80–125%
   - Вызов функций из `stat_tools` для ANOVA, CV<sub>intra</sub>, выявления выбросов и рекомендаций
   - Опциональный анализ клинических показателей через модули `blood_analysis` и визуализация
  
2. **`loader.py`**  
   - `load_randomization(file)`  
     Читает CSV-файл рандомизации (UTF-8-sig), возвращает словарь `{Subject: Sequence}`  
   - `load_timepoints(file)`  
     Читает CSV-файл временных точек, возвращает словарь `{Code: Time}`  
   - `parse_excel_files(xlsx_files, rand_dict, time_dict)`  
     Пробегает по каждому загруженному XLSX, определяет формат «CT» или стандартный:  
     - для формата «CT» извлекает из листа `CT` колонки `Subject`, `Time`, `Concentration, Period 1`, `Concentration, Period 2`  
       переводит единицы из µg/mL в ng/mL, определяет Treatment в зависимости от Sequence и периода  
     - для остальных листов ищет образцы по шаблону `A-<Subject>-<TimeCode>` или `B-<Subject>-<TimeCode>`,  
       получает время по коду, конвертирует концентрацию из µg/mL в ng/mL (умножением на 1000),  
       записывает в общий DataFrame со столбцами `Subject`, `Sequence`, `Period`, `Treatment`, `SampleLabel`, `TimeCode`, `Time`, `Concentration`  

3. **`pk.py`**  
   - `calc_auc(time, conc)`  
     Вычисляет AUC<sub>0–t</sub> методом трапеций (сортировка по времени)  
   - `calc_kel(concs, times, min_points=5, lloq=1.0)`  
     Рассчитывает k<sub>el</sub> и T<sub>1/2</sub> по лог-линейному участку (с учетом LLOQ), возвращает численность точек терминальной фазы  
   - `compute_pk(df, dose_test=100, dose_ref=100, min_points=4, lloq=1.0)`  
     Для каждой группы `(Subject, Period, Treatment)`:
     - проверяет наличие хотя бы одной концентрации > LLOQ
     - вычисляет C<sub>max</sub>, T<sub>max</sub>, AUC<sub>0–t</sub>, k<sub>el</sub>, T<sub>1/2</sub>, AUC<sub>0–∞</sub>, CL, Vd, MRT, T<sub>lag</sub>
     - возвращает DataFrame с колонками:
       ```
       Subject | Sequence | Treatment | Period | Cmax | Tmax | AUC0-t | AUC0-inf |
       Kel | T1/2 | N_el | CL | Vd | MRT | Tlag
       ```

4. **`stat_tools.py`**  
   - `log_diff_stats(pivot_df)`  
     Добавляет логарифмированные колонки ln(Cmax), ln(AUC0–t), ln(AUC0–∞) для Test и Ref, вычисляет разности логарифмов (`log_Cmax_diff`, `log_AUC0-t_diff`, `log_AUC0-inf_diff`)
   - `ci_calc(log_diff, alpha=0.1)`  
     Для вектора log-­разностей рассчитывает GMR = exp(mean), 90% CI = exp(mean ± t<sub>crit</sub>·SE)
   - `anova_log(df, colname)`  
     Проводит Type III ANOVA для лог-преобразованного столбца (с учетом факторов Sequence, Period, Treatment, Subject_in_Sequence), возвращает модель, таблицу ANOVA, MSE, df_resid  
   - `calc_swr(log_vals)`  
     Рассчитывает sWR и соответствующий CV по ICH: CV = √(exp(sWR²) – 1)·100  
   - `add_mse_se_to_pivot(pivot_df)`  
     Добавляет в pivot-DataFrame колонки `MSE_log_<param>` и `SE_log_<param>` для Cmax, AUC0–t, AUC0–∞  
   - `get_cv_intra_anova(df, param)`  
     Рассчитывает внутригрупповую вариабельность CV<sub>intra</sub> через ANOVA:  
     - логарифмирует значения
     - строит модель `log_val ~ C(Sequence) + C(Period) + C(Treatment) + C(Subject):C(Sequence)`  
     - извлекает MS_Error и преобразует в CV: `√(exp(MSError) – 1)·100`  
   - `get_gmr_ci_from_model(df, param, alpha=0.1)`  
     Строит ту же модель (см. выше), получает коэффициент для Treatment[Test] и его SE, рассчитывает 90% CI, возвращает GMR и CI  
   - `get_gmr_lsmeans(df, param, alpha=0.1)`  
     Оценивает разницу ls-means между Test и Ref (по лог-значениям) и строит 90% CI по формуле из SAS  
   - `mixed_anova(df, colname)`  
     Проводит повторные измерения ANOVA (AnovaRM) с между-субъектным фактором Sequence и внутри-субъектными Treatment, Period, возвращает таблицу ANOVA  
   - `nested_anova(df, colname)`  
     Осуществляет вложенную ANOVA 2×2 кроссовера Sequence (между), Subject(Sequence) (вложенный), Treatment и Period (внутри), возвращает результаты SS, DF, F, p-value  
   - `identify_be_outlier_and_recommend(...)`  
     (предположительно) выявляет субъектов, выводящих критерии BE за пределы, и формирует рекомендации по исправлению кривой

5. **`viz.py`**  
   - Предопределенные шкалы (min, max, step) для параметров общего анализа крови (ОАК) и общего анализа мочи (ОАМ)  
   - `plot_ci(ratios, lowers, uppers, labels)`  
     Рисует горизонтальный график доверительных интервалов соотношения T/R в процентах, черты на 80% и 125%  
   - `plot_individual(df, subject, test_name, ref_name)`  
     Строит линейный график концентрации vs время для данного субъекта в обоих периодах (Test и Ref)  
   - `plot_mean_curves(mean_df, test_name, ref_name, logscale=False)`  
     Рисует усредненные кривые концентраций Test и Ref; при `logscale=True` – логарифмическая ось Y с настраиваемыми тиками  
   - `plot_individual_log(df, subject, test_name, ref_name, terminal_points=3)`  
     Строит логарифмические профили, вычисляет регрессию терминального участка (по последним N точкам), отображает регрессионную прямую  
   - `plot_mean_sd(df, treatment_label, title=None)`  
     Строит среднюю ± 2×SD для выбранного лечения  
   - (и другие функции для построения «венгерских графиков», IQR, Studentized residuals, радарных графиков и т.д.)

6. **`blood_analysis.py`**  
   - Функции для загрузки и визуализации данных:
     - `load_oak_sheet(xls_file)` – загружает лист «ОАК» из Excel, подготавливает DataFrame с параметрами (Гемоглобин, Лейкоциты и т.д.)  
     - `extract_oak_pairwise(df, param_col, ...)` – формирует пары «до/после» по определённому параметру  
     - `plot_oak_pairwise(df_pair, title, ylabel)` – рисует сравнительный график «до/после»
     - `plot_all_oak_parameters(df, param_dict)` – цикл по всем параметрам ОАК  
     - Аналогичные функции для «БХАК» (`load_bhak_sheet`) и «ОАМ» (`load_oam_sheet`, `extract_individual_lab`)  

7. **`docx_tools.py`**  
   - Набор функций для экспорта отчетных таблиц в Word:
     - `export_individual_pk_tables(pk_df, test_name, ref_name, substance, dose_test, dose_ref, save_path)`  
       Генерирует документ с таблицами индивидуальных значений PK (Test и Ref) и сводными статистиками (N, Mean, Geom, Median, SD, SE, CV, квантили, min/max)  
     - `export_auc_residual_tables(df, test_name, ref_name, substance, dose_test, dose_ref, save_path)`  
       Создает таблицу с остаточной площадью AUC (%), сравнивает AUC<sub>0–t</sub> и AUC<sub>0–∞</sub>  
     - `export_log_transformed_pk_tables(pk_df, test_name, ref_name, substance, dose_test, dose_ref, save_path)`  
       Формирует таблицы с ln(AUC₀–t), ln(AUC₀–∞), ln(C<sub>max</sub>) для каждого субъекта, добавляет итоговую статистику (N, Mean, SD, SE, CV, квантили, min, max)  
     - `export_sas_anova_report(pk_df, substance, dose_test, save_path)`  
       Строит Type III nested ANOVA (вложенная модель) для каждого PK-параметра и оформляет Word-отчет (Model/Error/Corrected Total, Std Dev Residual, F Value, Pr > F, интерпретации)  
     - Иные функции для экспорта таблицы GMR/CI/CV, таблицы мощности (power analysis) и т.д.  

## Установка и запуск

1. **Клонировать репозиторий**  
   ```bash
   git clone <URL_Вашего_Репозитория>
   cd <Имя_Папки_Проекта>
   Форматы входных файлов
Файл рандомизации (CSV)

Должен содержать столбцы:

Subject (целочисленный идентификатор субъекта)

Sequence (строковый – "TR" или "RT")

Кодировка: UTF-8 (с BOM).

Файл точек (CSV)

Столбцы:

Code (двузначный код временной точки, например "01", "02")

Time (время в часах, соответствующее коду)

Пример:

css
Копировать
Редактировать
Code,Time
01,0
02,1
03,2
…
Файлы аналитика (XLSX)

Каждый файл – рабочая книга Excel, содержащая один или несколько листов. Поддерживаются два формата:

Лист “CT” (стандартный формат CT-аналитика):

Парсинг начинается с header=28 (29 строка заголовка).

Обязательные столбцы:

Subject

Time

Concentration, Period 1

Concentration, Period 2

Концентрации в µg/mL (преобразуются в ng/mL).

Листы с названиями, отличными от “CT” и “ValueList_Helper”:

Парсинг начинается с header=1 (2-я строка заголовка).

Обязательный столбец (или его аналоги):

SampleLabel или Name или Sample, содержащий строку вида A-<Subject>-<TimeCode> или B-<Subject>-<TimeCode>.

Значение концентрации берется из колонки Calc. Conc., ug/ml или соседних колонок (13-я/12-я позиция), переводится в ng/mL.

Код периода определяется по первой букве в SampleLabel:

A-… – период 1, B-… – период 2.

Treatment определяется на основании Sequence и номера периода (TR: период 1 → Test, период 2 → Ref; RT наоборот).

Файл с клинико-лабораторными данными добровольцев (XLSX или XLSM)

Должен содержать листы с названиями:

ОАК (общий анализ крови) – header=[1,4], колонки: № п/п, Этап регистрации, После приема, далее параметры ОАК

БХАК (биохимия крови) – header=[1,4], колонки: № п/п, Этап регистрации, После приема, далее параметры БХАК

ОАМ (общий анализ мочи) – header=[1,4], колонки: № п/п, Этап регистрации, После приема, далее параметры ОАМ

Структура аналогична файлам, подготавливаемым в соответствующих клинических исследованиях.

Использование приложения
Ввод дозировки
В боковой панели (sidebar) введите дозу тестового и референтного препаратов (в мг).

Загрузка файлов

Файл рандомизации (.csv): выбирается через виджет “Файл рандомизации”.

Файл временных точек (.csv): выбирается через виджет “Файл точек”.

Файлы аналитика (.xlsx): можно загрузить несколько файлов (accept_multiple_files=True).

Файл с данными добровольцев (.xlsx, xlsm): для анализа безопасности и лабораторных данных.

Выбор таблицы/графика для отчета

В боковой панели присутствует выпадающий список “Выберите таблицу” (например, GMR/CI/CV, ANOVA по Cmax, PK-таблица, графики профилей и т.д.). После выбора отображается соответствующая таблица или график в основной области.

Просмотр результатов PK

При успешной загрузке и обработке данных в разделе “📋 PK-параметры” появится интерактивная таблица с рассчитанными параметрами по субъектам.

Результаты биоэквивалентности

Сразу после PK-таблицы генерируется подтаблица “2. Результаты расчета” с GMR (%) и 90% CI (%). Поле “Bioequivalent” отмечает соответствие критериям (80–125%).

При нарушении критерия по C<sub>max</sub> автоматически выделяется «виновник» (субъект) и предлагаются рекомендации по корректировке профиля (функция identify_be_outlier_and_recommend).

ANOVA и sWR/CV<sub>intra</sub>

Раздел “📊 ANOVA (лог-преобразованные значения)” выводит таблицы Type III ANOVA для C<sub>max</sub>, AUC<sub>0–t</sub>, AUC<sub>0–∞</sub>.

Далее отображаются рассчитанные CV<sub>intra</sub> по ICH для каждого параметра (функция get_cv_intra_anova).

Визуализация

Разделы с графиками:

GMR и 90% CI – текстовое отображение численных значений и график CI (viz.plot_ci).

Индивидуальные профили (концентация vs время) для каждого субъекта (viz.plot_individual, viz.plot_individual_log).

Средние кривые ± 2×SD (viz.plot_mean_sd).

Другие специализированные графики (Studentized residuals, IQR, радарные диаграммы) можно вызвать, выбрав соответствующий пункт в sidebar (“Резко выделяющиеся наблюдения”).

Анализ безопасности

При отметке “Показать анализ клинических показателей” подтягиваются данные из листов ОАК, БХАК, ОАМ (модуль blood_analysis).

Для выбранного параметра строятся графики “до/после” (plot_oak_pairwise, plot_bhak_pairwise, plot_oam_pairwise).

Экспорт отчетных таблиц в Word

При нажатии соответствующих кнопок (или автоматизировано в backend) создаются .docx-файлы:

индивидуальные PK-таблицы (export_individual_pk_tables)

таблица остаточной площади AUC (export_auc_residual_tables)

лог-преобразованные PK-значения (export_log_transformed_pk_tables)

SAS-ANOVA-отчет (export_sas_anova_report)

таблица GMR/CI/CV (export_be_result_table)

таблица мощности (power analysis) (export_power_analysis_table)

Имя и путь сохранения можно задать в соответствующих функциях.
Зависимости
Минимальный набор библиотек (примерно, в requirements.txt):
streamlit==1.29.1
pandas>=1.5.0
numpy>=1.23.0
scipy>=1.9.0
statsmodels>=0.14.0
matplotlib>=3.7.0
python-docx>=0.8.11
openpyxl>=3.1.0

## Тестирование

В директории `tests` находятся как unit‑тесты, так и интеграционные проверки. Основные файлы:

- `test_pk.py` – проверяет функции расчёта AUC, Kel и `compute_pk`.
- `test_pk_workflow.py` – интеграционный тест функции `compute_pk_and_stats` с мокающими зависимостями.
- `test_loader_extra.py` – загрузка рандомизации и парсинг Excel‑файлов различных форматов.
- `test_docx_tools.py` и `test_docx_tools_extra.py` – создание DOCX‑отчётов.
- `test_viz.py` – гарантирует, что графические функции возвращают объекты `matplotlib.figure.Figure`.
- `test_app_run.py` и `test_app_e2e.py` – запуск Streamlit‑приложения в тестовом режиме.

Полный список тестов приведён в `tests_summary.md`.

Для запуска тестов используйте:

```bash
pytest --cov=. --cov-report=term
```

Минимальное покрытие — **50%**. Рекомендуется получать >85% для `pk.py`, `stat_tools.py` и `src/pk_workflow.py`. После прогона можно сгенерировать html‑отчёт:

```bash
coverage html
open htmlcov/index.html
```

